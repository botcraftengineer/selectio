# Bot Manager - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –±–æ—Ç–∞–º–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–í–º–µ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞ –æ–¥–Ω–æ–≥–æ –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ—Ç **–Ω–µ—Å–∫–æ–ª—å–∫–æ –±–æ—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** - –ø–æ –æ–¥–Ω–æ–º—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ workspace —Å –∞–∫—Ç–∏–≤–Ω–æ–π Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –≤ –ë–î

–°–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `integrations`:

```sql
SELECT * FROM integrations WHERE type = 'telegram';
```

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
- `workspace_id` - ID workspace
- `type` - "telegram"
- `credentials` - –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (apiId, apiHash, sessionData)
- `is_active` - –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### 2. BotManager

Singleton –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –±–æ—Ç–∞–º–∏:

```typescript
import { botManager } from "@selectio/tg-client";

// –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –∏–∑ –ë–î
await botManager.startAll();

// –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –±–æ—Ç–∞—Ö
const bots = botManager.getBotsInfo();
// [{ workspaceId: "ws_123", userId: "123456", username: "bot_user" }]

// –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ workspace
await botManager.restartBot("ws_123");

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ—Ö –±–æ—Ç–æ–≤
await botManager.stopAll();
```

### 3. –ó–∞–ø—É—Å–∫

```bash
# –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –∏–∑ –ë–î
bun run bot

# –ò–ª–∏ —Å hot reload
bun run bot:dev
```

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ:
1. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–∑ –ë–î
2. –î–ª—è –∫–∞–∂–¥–æ–π —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π TelegramClient
3. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Å–µ—Å—Å–∏—è –∏–∑ `credentials.sessionData`
4. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
5. –ë–æ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–ª—É—à–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

## API BotManager

### startAll()

–ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ—Ö –±–æ—Ç–æ–≤ –∏–∑ –ë–î:

```typescript
await botManager.startAll();
```

–õ–æ–≥–∏–∫–∞:
- –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å `type = "telegram"` –∏ `is_active = "true"`
- –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞
- –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—É—Å–ø–µ—à–Ω–æ/–æ—à–∏–±–∫–∏)

### stopAll()

–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ—Ö –±–æ—Ç–æ–≤:

```typescript
await botManager.stopAll();
```

### restartBot(workspaceId)

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ workspace:

```typescript
await botManager.restartBot("ws_123");
```

–ü–æ–ª–µ–∑–Ω–æ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∏–ª–∏ credentials.

### getBotsInfo()

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –±–æ—Ç–∞—Ö:

```typescript
const bots = botManager.getBotsInfo();
// [
//   {
//     workspaceId: "ws_123",
//     integrationId: "int_456",
//     userId: "123456",
//     username: "bot_user"
//   }
// ]
```

### getClient(workspaceId)

–ü–æ–ª—É—á–∏—Ç—å TelegramClient –¥–ª—è workspace:

```typescript
const client = botManager.getClient("ws_123");
if (client) {
  await client.sendText(chatId, "–ü—Ä–∏–≤–µ—Ç!");
}
```

### isRunningForWorkspace(workspaceId)

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ –±–æ—Ç:

```typescript
if (botManager.isRunningForWorkspace("ws_123")) {
  console.log("–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç");
}
```

### getBotsCount()

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤:

```typescript
const count = botManager.getBotsCount();
console.log(`–ó–∞–ø—É—â–µ–Ω–æ ${count} –±–æ—Ç–æ–≤`);
```

## –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

### –ß–µ—Ä–µ–∑ BotManager

```typescript
const client = botManager.getClient(workspaceId);
if (client) {
  await client.sendText(chatId, "–°–æ–æ–±—â–µ–Ω–∏–µ");
}
```

### –ß–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API

–§—É–Ω–∫—Ü–∏—è `sendMessage` –∏–∑ `bot-handler.ts` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ:

```typescript
import { sendMessage } from "@selectio/tg-client";

await sendMessage(client, chatId, "–°–æ–æ–±—â–µ–Ω–∏–µ");
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

–ö–∞–∂–¥—ã–π –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑ `bot-handler.ts`:

- `/start` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≥–æ–ª–æ—Å–æ–≤–æ–º
- –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - –∑–∞–≥—Ä—É–∑–∫–∞ –≤ S3 –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è

–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ `conversation`.

## Graceful Shutdown

–ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ (SIGINT/SIGTERM):

```typescript
process.on("SIGINT", async () => {
  await botManager.stopAll();
  process.exit(0);
});
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- –£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤
- –û—à–∏–±–∫–∏ –∑–∞–ø—É—Å–∫–∞
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –±–æ—Ç–µ (workspace, username)

```
üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö Telegram –±–æ—Ç–æ–≤...
üìã –ù–∞–π–¥–µ–Ω–æ 3 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –¥–ª—è workspace ws_123: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ (@ivan_bot)
‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –¥–ª—è workspace ws_456: –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤ (@petr_bot)
‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –¥–ª—è workspace ws_789: Not authorized
‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ: 2
‚ùå –û—à–∏–±–æ–∫: 1
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –±–æ—Ç–∞–º–∏  
‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –≤—Å–µ –±–æ—Ç—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫** - –Ω–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∫–∞–∂–¥–æ–≥–æ –±–æ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ  
‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è** - –∫–∞–∂–¥—ã–π workspace –∏–º–µ–µ—Ç —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ –ë–î ‚Üí –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è  

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å env variables

–†–∞–Ω—å—à–µ:
```env
TELEGRAM_API_ID=123456
TELEGRAM_API_HASH=abc123
```

–¢–µ–ø–µ—Ä—å:
```sql
INSERT INTO integrations (workspace_id, type, name, credentials, is_active)
VALUES (
  'ws_123',
  'telegram',
  'Telegram Bot',
  '{"apiId": "123456", "apiHash": "abc123", "sessionData": "..."}',
  'true'
);
```

Credentials –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.
