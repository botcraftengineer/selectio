import { eq } from "@selectio/db";
import { db } from "@selectio/db/client";
import {
  companySettings,
  responseScreening,
  vacancyResponse,
} from "@selectio/db/schema";
import { generateText } from "../lib/ai-client";

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
 */
export async function generateWelcomeMessage(responseId: string) {
  console.log(
    `üëã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–∫–ª–∏–∫–∞ ${responseId}`
  );

  const response = await db.query.vacancyResponse.findFirst({
    where: eq(vacancyResponse.id, responseId),
    with: {
      vacancy: true,
    },
  });

  if (!response) {
    throw new Error(`–û—Ç–∫–ª–∏–∫ ${responseId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
  }

  const screening = await db.query.responseScreening.findFirst({
    where: eq(responseScreening.responseId, responseId),
  });

  const [company] = await db.select().from(companySettings).limit(1);

  const prompt = buildWelcomePrompt(response, screening, company);

  console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è`);

  const { text } = await generateText({
    prompt,
    temperature: 0.7,
    generationName: "candidate-welcome",
    entityId: responseId,
    metadata: {
      responseId,
      vacancyId: response.vacancyId,
      candidateName: response.candidateName,
    },
  });

  console.log(`üì• –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ`);

  return text.trim();
}

interface ResponseWithVacancy {
  id: string;
  vacancyId: string;
  candidateName: string | null;
  about: string | null;
  vacancy: {
    title: string | null;
    description: string | null;
  } | null;
}

function buildWelcomePrompt(
  response: ResponseWithVacancy,
  screening: typeof responseScreening.$inferSelect | undefined,
  company: typeof companySettings.$inferSelect | undefined
): string {
  const companyName = company?.name || "–Ω–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è";
  const companyDescription = company?.description || "";
  const companyWebsite = company?.website || "";

  return `–¢—ã ‚Äî —Ä–µ–∫—Ä—É—Ç–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏ "${companyName}". –ù–∞–ø–∏—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–û–ú–ü–ê–ù–ò–ò:
–ù–∞–∑–≤–∞–Ω–∏–µ: ${companyName}
${companyDescription ? `–û–ø–∏—Å–∞–Ω–∏–µ: ${companyDescription}` : ""}
${companyWebsite ? `–°–∞–π—Ç: ${companyWebsite}` : ""}

–û –ö–û–ú–ü–ê–ù–ò–ò (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):
${companyName} ‚Äî —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è IT-–∫–æ–º–ø–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ü–µ–Ω–∏—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º, –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ. –ú—ã —Å–æ–∑–¥–∞–µ–º –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏. –£ –Ω–∞—Å –¥—Ä—É–∂–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞, –≥–∏–±–∫–∏–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–∞–±–æ—Ç–µ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–æ—Å—Ç–∞.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –í–ê–ö–ê–ù–°–ò–ò:
–ü–æ–∑–∏—Ü–∏—è: ${response.vacancy?.title || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}
${response.vacancy?.description ? `–û–ø–∏—Å–∞–Ω–∏–µ: ${response.vacancy.description.substring(0, 200)}...` : ""}

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–ê–ù–î–ò–î–ê–¢–ï:
–§–ò–û: ${response.candidateName || "–ö–∞–Ω–¥–∏–¥–∞—Ç"}
${response.about ? `–û —Å–µ–±–µ: ${response.about.substring(0, 150)}...` : ""}

–†–ï–ó–£–õ–¨–¢–ê–¢–´ –°–ö–†–ò–ù–ò–ù–ì–ê –ö–ê–ù–î–ò–î–ê–¢–ê:
${
  screening
    ? `
–û—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è: ${screening.score}/5 (–¥–µ—Ç–∞–ª—å–Ω–∞—è: ${screening.detailedScore}/100)
–ê–Ω–∞–ª–∏–∑: ${screening.analysis || "–ù–µ —É–∫–∞–∑–∞–Ω"}

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–∞–Ω–¥–∏–¥–∞—Ç ${
        screening.score >= 4
          ? "–æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç"
          : screening.score === 3
            ? "—Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥–∏—Ç"
            : "–ø–æ–¥—Ö–æ–¥–∏—Ç"
      } –¥–ª—è –¥–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏.
`
    : "–°–∫—Ä–∏–Ω–∏–Ω–≥ –µ—â–µ –Ω–µ –ø—Ä–æ–≤–µ–¥–µ–Ω"
}

–ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ª–∏—Ü–∞ —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–∏. 

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ü–∏—à–∏ —Ç–∞–∫, –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫-—Ä–µ–∫—Ä—É—Ç–µ—Ä –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –ª–∏—á–Ω–æ
- –û–±—Ä–∞—â–∞–π—Å—è –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç—É –¢–û–õ–¨–ö–û –ü–û –ò–ú–ï–ù–ò (–±–µ–∑ —Ñ–∞–º–∏–ª–∏–∏ –∏ –æ—Ç—á–µ—Å—Ç–≤–∞). –ï—Å–ª–∏ –≤ –§–ò–û –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ (–∏–º—è)
- –£–ø–æ–º—è–Ω–∏ –ø–æ–∑–∏—Ü–∏—é, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –æ–Ω –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è
- –ü–æ–∫–∞–∂–∏ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤ –∫–∞–Ω–¥–∏–¥–∞—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞
- –ï—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ –≤—ã—Å–æ–∫–∞—è (4-5), –ø–æ–∫–∞–∂–∏ –±–æ–ª—å—à–∏–π —ç–Ω—Ç—É–∑–∏–∞–∑–º
- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º, —Ç–µ–ø–ª—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –æ—Ü–µ–Ω–æ–∫ –∏–ª–∏ —á—Ç–æ –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è —Å–∫—Ä–∏–Ω–∏–Ω–≥
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —ç—Ç–æ –±–æ—Ç –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –∏–ª–∏ —à–∞–±–ª–æ–Ω–Ω—ã–π —è–∑—ã–∫
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ –æ—Ç—á–µ—Å—Ç–≤–æ, —Ç–æ–ª—å–∫–æ –∏–º—è
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø–æ–¥–ø–∏—Å—å –∏–ª–∏ –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ –∫–æ–Ω—Ü–µ

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∫–∞–≤—ã—á–µ–∫ –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.`;
}
